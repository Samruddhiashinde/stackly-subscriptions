{% schema %}
{
  "name": "Subscription Selector",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Purchase Options"
    },
    {
      "type": "textarea",
      "id": "subscription_benefits",
      "label": "Subscription Benefits",
      "default": "Cancel anytime • Skip or pause easily • Free shipping"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add to Cart"
    },
    {
      "type": "text",
      "id": "buy_now_text",
      "label": "Buy Now Button Text",
      "default": "Buy Now"
    },
    {
      "type": "text",
      "id": "plan_name_filter",
      "label": "Subscription Plan Name",
      "info": "Enter the exact name of your active subscription plan (e.g., 'Monthly Subscription'). Leave blank to show all plans."
    }
  ]
}
{% endschema %}

<div class="subscription-selector-block">
  <h3>{{ block.settings.title }}</h3>
  
  {% comment %} DEBUG INFO - Remove this later {% endcomment %}
  <div style="background: #fffbeb; padding: 1rem; border: 1px solid #fbbf24; border-radius: 4px; margin-bottom: 1rem;">
    <strong>Debug Info:</strong><br>
    Product ID: {{ product.id }}<br>
    Product requires selling plan: {{ product.requires_selling_plan }}<br>
    Number of selling plan groups: {{ product.selling_plan_groups.size }}<br>
    Plan filter: "{{ block.settings.plan_name_filter }}"<br>
    {% if product.selling_plan_groups.size > 0 %}
      Available plans:
      <ul>
        {% for group in product.selling_plan_groups %}
          <li>{{ group.name }} ({{ group.selling_plans.size }} options)</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
  
  {% if product.selling_plan_groups.size > 0 %}
    <div class="subscription-options">
      {% assign plan_filter = block.settings.plan_name_filter %}
      {% assign found_plans = false %}
      
      {% for group in product.selling_plan_groups %}
        {% comment %} Show all plans if filter is empty, or only matching plan {% endcomment %}
        {% if plan_filter == blank or group.name == plan_filter %}
          {% assign found_plans = true %}
          
          <div class="selling-plan-group">
            <h4>{{ group.name }}</h4>
            
            {% for plan in group.selling_plans %}
              <label class="selling-plan-option">
                <input 
                  type="radio" 
                  name="selling_plan" 
                  value="{{ plan.id }}"
                  data-plan-name="{{ plan.name }}"
                  class="selling-plan-radio"
                >
                <span class="plan-details">
                  <span class="plan-name">{{ plan.name }}</span>
                  {% if plan.price_adjustments.size > 0 %}
                    {% assign adjustment = plan.price_adjustments.first %}
                    <span class="plan-discount">Save {{ adjustment.value }}%</span>
                  {% endif %}
                </span>
              </label>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}
      
      {% unless found_plans %}
        <div class="no-plans-message">
          <p>
            {% if plan_filter != blank %}
              No subscription plan named "{{ plan_filter }}" found for this product. 
              Available plans are listed in the debug info above.
            {% else %}
              No subscription plans match your filter.
            {% endif %}
          </p>
        </div>
      {% endunless %}
      
      {% if found_plans %}
        <div class="subscription-benefits">
          <p>{{ block.settings.subscription_benefits }}</p>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="no-plans-message">
      <p><strong>⚠️ This product doesn't have subscription options available.</strong></p>
      <p style="font-size: 0.875rem; margin-top: 0.5rem;">
        To fix this, go to <strong>Products → Select this product → Scroll to Selling Plans → Click Manage → 
        Select your subscription plan → Save</strong>
      </p>
    </div>
  {% endif %}
  
  <button class="add-to-cart-btn" id="subscription-add-to-cart">
    {{ block.settings.add_to_cart_text }}
  </button>
  <button class="buy-now-btn" id="subscription-buy-now">
    {{ block.settings.buy_now_text }}
  </button>
</div>

<style>
  .subscription-selector-block {
    padding: 1.5rem;
    border: 2px solid #008060;
    border-radius: 8px;
    margin: 1.5rem 0;
    background-color: #f9fafb;
  }
  
  .subscription-selector-block h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: #202223;
  }
  
  .subscription-options {
    margin-bottom: 1rem;
  }
  
  .selling-plan-group {
    margin: 1rem 0;
  }
  
  .selling-plan-group h4 {
    color: #008060;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
  }
  
  .selling-plan-option {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin: 0.75rem 0;
    border: 2px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    background-color: white;
  }
  
  .selling-plan-option:hover {
    border-color: #008060;
    background-color: #f0fdf4;
  }
  
  .selling-plan-option:has(input:checked) {
    border-color: #008060;
    background-color: #f0fdf4;
  }
  
  .selling-plan-radio {
    margin-right: 0.75rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .plan-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .plan-name {
    font-weight: 600;
    color: #202223;
  }
  
  .plan-discount {
    font-size: 0.875rem;
    color: #008060;
    font-weight: 500;
  }
  
  .subscription-benefits {
    margin: 1.5rem 0;
    padding: 1rem;
    background-color: #f0fdf4;
    border-left: 4px solid #10b981;
    border-radius: 4px;
  }
  
  .subscription-benefits p {
    margin: 0;
    color: #166534;
    font-size: 0.9375rem;
  }
  
  .no-plans-message {
    padding: 2rem;
    text-align: center;
    background-color: #f3f4f6;
    border-radius: 6px;
    margin: 1rem 0;
  }
  
  .no-plans-message p {
    margin: 0;
    color: #6b7280;
  }
  
  .add-to-cart-btn,
  .buy-now-btn {
    width: 100%;
    padding: 1rem;
    margin: 0.5rem 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
  }
  
  .add-to-cart-btn {
    background-color: #008060;
    color: white;
  }
  
  .add-to-cart-btn:hover {
    background-color: #006e52;
  }
  
  .buy-now-btn {
    background-color: white;
    color: #202223;
    border: 2px solid #c9cccf;
  }
  
  .buy-now-btn:hover {
    border-color: #008060;
  }
  
  .add-to-cart-btn:disabled,
  .buy-now-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const addToCartBtn = document.getElementById('subscription-add-to-cart');
    const buyNowBtn = document.getElementById('subscription-buy-now');
    
    function getSelectedPlan() {
      return document.querySelector('.selling-plan-radio:checked');
    }
    
    // Add to cart with subscription
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const selectedPlan = getSelectedPlan();
        
        if (!selectedPlan) {
          alert('Please select a subscription plan');
          return;
        }
        
        console.log('Adding to cart with subscription plan:', selectedPlan.value);
        // TODO: Implement actual add to cart logic here
      });
    }
    
    // Buy now with subscription
    if (buyNowBtn) {
      buyNowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const selectedPlan = getSelectedPlan();
        
        if (!selectedPlan) {
          alert('Please select a subscription plan');
          return;
        }
        
        console.log('Buy now with subscription plan:', selectedPlan.value);
        // TODO: Implement actual buy now logic here
      });
    }
  });
</script>
